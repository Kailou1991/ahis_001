{% extends 'base.html' %}
{% block content %}
<div class="container mt-4" style="margin-left: 20%;">
  <div style="width: 600px;">
    <div class="card-header bg-primary text-white text-center">
      <h3 class="mb-0">
        {% if update %}üìù Modification{% else %}üÜï Nouvel{% endif %} enregistrement d'abattage
      </h3>
    </div>
    
      <form method="post" novalidate>
        {% csrf_token %}
        {% for field in form %}
          <div class="mb-3">
            {{ field.label_tag }}
            {{ field }}
            {% if field.help_text %}
              <small class="form-text text-muted">{{ field.help_text }}</small>
            {% endif %}
            {% for error in field.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        {% endfor %}
        </br>
        <div class="text-end mt-3 text-center">
          <button type="submit" class="btn btn-success">üíæ Enregistrer</button>
          <a href="{% url 'liste_abattage' %}" class="btn btn-secondary">‚Ü©Ô∏è Retour</a>
        </div>
      </form>
   
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const regionSelect = document.querySelector('select[name="region"]');
    const departementSelect = document.querySelector('select[name="departement"]');
    const communeSelect = document.querySelector('select[name="commune"]');
  
    function loadDepartements(regionId, selectedDepartementId = null, selectedCommuneId = null) {
      fetch(`/api/departements/?region_id=${regionId}`)
        .then(res => res.json())
        .then(data => {
          departementSelect.innerHTML = '<option value="">---------</option>';
          data.forEach(item => {
            const selected = selectedDepartementId && item.id == selectedDepartementId ? 'selected' : '';
            departementSelect.innerHTML += `<option value="${item.id}" ${selected}>${item.Nom}</option>`;
          });
  
          // Charger les communes seulement apr√®s avoir inject√© les d√©partements
          if (selectedDepartementId) {
            departementSelect.value = selectedDepartementId;
            loadCommunes(selectedDepartementId, selectedCommuneId);
          }
        });
    }
  
    function loadCommunes(departementId, selectedId = null) {
      fetch(`/api/communes/?departement_id=${departementId}`)
        .then(res => res.json())
        .then(data => {
          communeSelect.innerHTML = '<option value="">---------</option>';
          data.forEach(item => {
            const selected = selectedId && item.id == selectedId ? 'selected' : '';
            communeSelect.innerHTML += `<option value="${item.id}" ${selected}>${item.Nom}</option>`;
          });
  
          if (selectedId) {
            communeSelect.value = selectedId;
          }
        });
    }
  
    // Cascade dynamique lors du changement manuel
    regionSelect.addEventListener('change', () => {
      const regionId = regionSelect.value;
      if (regionId) {
        loadDepartements(regionId);
      } else {
        departementSelect.innerHTML = '<option value="">---------</option>';
        communeSelect.innerHTML = '<option value="">---------</option>';
      }
    });
  
    departementSelect.addEventListener('change', () => {
      const departementId = departementSelect.value;
      if (departementId) {
        loadCommunes(departementId);
      } else {
        communeSelect.innerHTML = '<option value="">---------</option>';
      }
    });
  
    // Pr√©chargement si en mode modification
    {% if form.instance.pk %}
      const selectedRegion = "{{ form.instance.region.id }}";
      const selectedDepartement = "{{ form.instance.departement.id }}";
      const selectedCommune = "{{ form.instance.commune.id }}";
  
      if (selectedRegion && selectedDepartement && selectedCommune) {
        loadDepartements(selectedRegion, selectedDepartement, selectedCommune);
      }
    {% endif %}
  });
  </script>
  
{% endblock %}
