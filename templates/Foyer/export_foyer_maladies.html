{% extends 'base.html' %}
{% load static %}
{% load form_tags %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center">Exporter les données de Foyers de Maladie</h2>

  <!-- Formulaire de filtre (GET) -->
  <form method="get" class="needs-validation mt-4" novalidate>
    <div class="row align-items-end g-3">
      <div class="col-md-2">
        <label for="id_region" class="form-label">Choisir la Région</label>
        {{ form.region }}
        {% if form.region.errors %}
          <div class="text-danger small">{{ form.region.errors }}</div>
        {% endif %}
      </div>

      <div class="col-md-2">
        <label for="id_maladie" class="form-label">Choisir la Maladie</label>
        {{ form.maladie }}
        {% if form.maladie.errors %}
          <div class="text-danger small">{{ form.maladie.errors }}</div>
        {% endif %}
      </div>

      <div class="col-md-2">
        <label for="id_periode_type" class="form-label">Choisir la période</label>
        {{ form.periode_type }}
        {% if form.periode_type.errors %}
          <div class="text-danger small">{{ form.periode_type.errors }}</div>
        {% endif %}
      </div>

      <div class="col-md-2" id="semaine_field" style="display:none;">
        <label for="id_semaine" class="form-label">Hebdomadaire (1‑52)</label>
        {{ form.semaine }}
        {% if form.semaine.errors %}
          <div class="text-danger small">{{ form.semaine.errors }}</div>
        {% endif %}
      </div>

      <div class="col-md-2" id="mois_field" style="display:none;">
        <label for="id_mois" class="form-label">Mensuel</label>
        {{ form.mois }}
        {% if form.mois.errors %}
          <div class="text-danger small">{{ form.mois.errors }}</div>
        {% endif %}
      </div>

      <div class="col-md-2" id="trimestre_field" style="display:none;">
        <label for="id_trimestre" class="form-label">Trimestriel</label>
        {{ form.trimestre }}
        {% if form.trimestre.errors %}
          <div class="text-danger small">{{ form.trimestre.errors }}</div>
        {% endif %}
      </div>

      <div class="col-md-2" id="semestre_field" style="display:none;">
        <label for="id_semestre" class="form-label">Semestriel</label>
        {{ form.semestre }}
        {% if form.semestre.errors %}
          <div class="text-danger small">{{ form.semestre.errors }}</div>
        {% endif %}
      </div>

      <div class="col-md-2" id="annee_field">
        <label for="id_annee" class="form-label">Annuel</label>
        {{ form.annee }}
        {% if form.annee.errors %}
          <div class="text-danger small">{{ form.annee.errors }}</div>
        {% endif %}
      </div>

      <div class="col-md-4 d-flex gap-2">
        <button type="submit" class="btn btn-primary mt-2">Appliquer les filtres</button>

        <!-- Bouton Export : envoie les mêmes filtres + export=1 -->
        <button type="button" id="btn-export" class="btn btn-success mt-2">
          Exporter Excel
        </button>
      </div>
    </div>
  </form>

  <!-- Section de la carte -->
  <div class="mt-5">
    <h3 class="text-center">Carte des Foyers</h3>
    <div id="map-container" class="card shadow-sm border-0">
      <div class="card-body p-0">
        {{ map_html|safe }}
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    // Affichage conditionnel des champs selon la période
    const periodeTypeField = document.getElementById('id_periode_type');
    const semaineField = document.getElementById('semaine_field');
    const moisField = document.getElementById('mois_field');
    const trimestreField = document.getElementById('trimestre_field');
    const semestreField = document.getElementById('semestre_field');

    function updateFields() {
      const v = (periodeTypeField?.value || '').toLowerCase();
      // cacher tout
      [semaineField, moisField, trimestreField, semestreField].forEach(el => { if (el) el.style.display = 'none'; });
      // montrer celui concerné
      if (v === 'hebdomadaire')      { if (semaineField)   semaineField.style.display   = 'block'; }
      else if (v === 'mensuel')      { if (moisField)      moisField.style.display      = 'block'; }
      else if (v === 'trimestriel')  { if (trimestreField) trimestreField.style.display = 'block'; }
      else if (v === 'semestriel')   { if (semestreField)  semestreField.style.display  = 'block'; }
    }

    updateFields();
    if (periodeTypeField) periodeTypeField.addEventListener('change', updateFields);

    // Bouton export : garde les mêmes paramètres + export=1
    const btnExport = document.getElementById('btn-export');
    btnExport?.addEventListener('click', function () {
      // On lit la query actuelle et on ajoute/écrase export=1
      const url = new URL(window.location.href);
      const form = document.querySelector('form[method="get"]');
      // injecter toutes les valeurs du form dans l'URL
      if (form) {
        const fd = new FormData(form);
        for (const [k, v] of fd.entries()) {
          if (v !== '') url.searchParams.set(k, v);
          else url.searchParams.delete(k);
        }
      }
      url.searchParams.set('export', '1');
      // Redirection (télécharge l'Excel)
      window.location.href = url.toString();
    });
  })();
</script>

<style>
  /* Éviter marges excessives */
  .container.mt-5 { margin-top: 2rem !important; }

  /* Carte en pleine largeur de la card */
  #map-container .folium-map { height: 70vh !important; }
  #map-container #map { height: 70vh !important; }

  /* Désactiver scroll horizontal intempestif */
  body .content-scroll { overflow-y: hidden !important; }
</style>
{% endblock %}
