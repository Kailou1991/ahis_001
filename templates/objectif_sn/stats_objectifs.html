{% extends "base.html" %}
{% load static humanize %}

{% block content %}
<div class="content-wrapper">
  <section class="content-header">
    <h1>Objectifs – Statistiques & Liste</h1>
  </section>

  <section class="content">

    <!-- Filtres -->
    <div class="box box-primary">
      <div class="box-header with-border"><h3 class="box-title">Filtres</h3></div>
      <div class="box-body">
        <form method="get" class="form-inline" style="gap:8px; display:flex; flex-wrap:wrap;">
          <div class="form-group">
            <label for="campagne">Campagne</label>
            <select id="campagne" name="campagne" class="form-control">
              <option value="">— Toutes —</option>
              {% for c in campaigns %}
                <option value="{{ c }}" {% if filters.campagne == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="maladie">Maladie</label>
            <select id="maladie" name="maladie" class="form-control">
              <option value="">— Toutes —</option>
              {% for m in maladies %}
                <option value="{{ m }}" {% if filters.maladie == m %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="region">Région</label>
            <select id="region" name="region" class="form-control">
              <option value="">— Toutes —</option>
              {% for r in regions %}
                <option value="{{ r }}" {% if filters.region == r %}selected{% endif %}>{{ r }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="departement">Département</label>
            <select id="departement" name="departement" class="form-control">
              <option value="">— Tous —</option>
              {% for d in departements %}
                <option value="{{ d }}" {% if filters.departement == d %}selected{% endif %}>{{ d }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn btn-primary">
            <i class="fa fa-filter"></i> Filtrer
          </button>
          <a href="{% url 'objectif_sn:stats_objectifs' %}" class="btn btn-default">Réinitialiser</a>
        </form>
      </div>
    </div>

    <!-- Données JS pour dépendance Région → Départements -->
    {{ region_dept_map|json_script:"regionDeptData" }}
    <script>
      (function() {
        var map = JSON.parse(document.getElementById('regionDeptData').textContent || '{}');
        var regionSel = document.getElementById('region');
        var deptSel   = document.getElementById('departement');
        var selectedDept = "{{ filters.departement|escapejs }}";

        function refillDepartments(region) {
          var all = [];
          if (region && map[region]) {
            all = map[region];
          } else {
            // tous les départements uniques si pas de région sélectionnée
            var set = new Set();
            Object.keys(map).forEach(function(r) { map[r].forEach(function(d){ set.add(d); }); });
            all = Array.from(set).sort();
          }

          var current = deptSel.value;
          deptSel.innerHTML = "";
          var optEmpty = document.createElement('option');
          optEmpty.value = ""; optEmpty.textContent = "— Tous —";
          deptSel.appendChild(optEmpty);

          all.forEach(function(d) {
            var opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            if ((selectedDept && d === selectedDept) || (!selectedDept && d === current)) {
              opt.selected = true;
            }
            deptSel.appendChild(opt);
          });
        }

        regionSel.addEventListener('change', function() {
          selectedDept = ""; // reset si on change de région
          refillDepartments(regionSel.value);
        });

        // Initial
        refillDepartments(regionSel.value);
      })();
    </script>

    <!-- Totaux -->
    <div class="row">
      <div class="col-sm-4">
        <div class="small-box bg-aqua">
          <div class="inner">
            <h3>{{ totals.cible|default:0|intcomma }}</h3>
            <p>Effectif cible</p>
          </div>
          <div class="icon"><i class="fa fa-bullseye"></i></div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="small-box bg-green">
          <div class="inner">
            <h3>{{ totals.elligible|default:0|intcomma }}</h3>
            <p>Effectif éligible</p>
          </div>
          <div class="icon"><i class="fa fa-users"></i></div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="small-box bg-yellow">
          <div class="inner">
            <h3>{{ totals.taux_elig|floatformat:1 }}%</h3>
            <p>Taux d'éligibilité</p>
          </div>
          <div class="icon"><i class="fa fa-percent"></i></div>
        </div>
      </div>
    </div>

    <!-- Liste -->
    <div class="box">
      <div class="box-header with-border">
        <h3 class="box-title">Résultats ({{ totals.rows|intcomma }})</h3>
      </div>

      <div class="box-body table-responsive no-padding">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Date soumission</th>
              <th>Campagne</th>
              <th>Région</th>
              <th>Département</th>
              <th>Commune</th>
              <th>Maladie</th>
              <th class="text-right">Cible</th>
              <th class="text-right">Éligible</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td>{{ r.parent.submission_time|date:"Y-m-d H:i" }}</td>
                <td>{{ r.parent.campagne|default:"—" }}</td>
                <td>{{ r.parent.grp4_region|default:"—" }}</td>
                <td>{{ r.parent.grp4_departement|default:"—" }}</td>
                <td>{{ r.commune|default:"—" }}</td>
                <td>{{ r.maladie_masse|default:"—" }}</td>
                <td class="text-right">{{ r.effectif_cible|default:0|intcomma }}</td>
                <td class="text-right">{{ r.effectif_elligible|default:0|intcomma }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="8" class="text-center">Aucune donnée.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
      <div class="box-footer clearfix">
        <ul class="pagination pagination-sm no-margin pull-right">
          {% if page_obj.has_previous %}
            <li><a href="?page=1&campagne={{ filters.campagne|urlencode }}&maladie={{ filters.maladie|urlencode }}&region={{ filters.region|urlencode }}&departement={{ filters.departement|urlencode }}">&laquo;</a></li>
            <li><a href="?page={{ page_obj.previous_page_number }}&campagne={{ filters.campagne|urlencode }}&maladie={{ filters.maladie|urlencode }}&region={{ filters.region|urlencode }}&departement={{ filters.departement|urlencode }}">&lsaquo;</a></li>
          {% else %}
            <li class="disabled"><span>&laquo;</span></li>
            <li class="disabled"><span>&lsaquo;</span></li>
          {% endif %}

          <li class="active"><span>Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>

          {% if page_obj.has_next %}
            <li><a href="?page={{ page_obj.next_page_number }}&campagne={{ filters.campagne|urlencode }}&maladie={{ filters.maladie|urlencode }}&region={{ filters.region|urlencode }}&departement={{ filters.departement|urlencode }}">&rsaquo;</a></li>
            <li><a href="?page={{ page_obj.paginator.num_pages }}&campagne={{ filters.campagne|urlencode }}&maladie={{ filters.maladie|urlencode }}&region={{ filters.region|urlencode }}&departement={{ filters.departement|urlencode }}">&raquo;</a></li>
          {% else %}
            <li class="disabled"><span>&rsaquo;</span></li>
            <li class="disabled"><span>&raquo;</span></li>
          {% endif %}
        </ul>
      </div>
      {% endif %}
    </div>

  </section>
</div>
{% endblock %}
