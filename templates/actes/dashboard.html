{% extends 'base.html' %}
{% load monetaires %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">ğŸ“Š Tableau de bord - des demandes d'actes administratifs</h2>
<!-- SÃ©lecteur de rÃ©gion -->
</br>
<form method="get" class="row g-2 align-items-center mb-4">
    <!-- RÃ©gion -->
    <div class="col-auto">
        <label for="region" class="form-label mb-0">
            ğŸ“ RÃ©gion :
        </label>
    </div>
    <div class="col-md-3 col-sm-6">
        <select name="region" id="region" class="form-select">
            <option value="">Toutes les rÃ©gions</option>
            {% for reg in regions %}
                <option value="{{ reg.id }}" {% if reg.id|stringformat:"s" == region_id %}selected{% endif %}>
                    {{ reg.Nom }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Bouton -->
    <div class="col-auto">
        <button type="submit" class="btn btn-success">
            <i class="fa fa-filter me-1"></i> Filtrer
        </button>
    </div>
</form>

</br>
    <!-- KPI Cards -->
    <div class="row text-center mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h5 class="card-title">ğŸ—‚ï¸ Total demandes</h5>
                    <p class="display-6">{{ total_demandes }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h5 class="card-title">ğŸ“¬ En cours</h5>
                    <p class="display-6">{{ en_cours }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-success">
                <div class="card-body">
                    <h5 class="card-title">âœ… ValidÃ©es</h5>
                    <p class="display-6">{{ delivrees }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-info">
                <div class="card-body">
                    <h5 class="card-title">ğŸ“„ DÃ©livrÃ©es</h5>
                    <p class="display-6">{{ delivrees }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row text-center mb-5">
        <div class="col-md-3 mb-3">
            <div class="card border-danger">
                <div class="card-body">
                    <h5 class="card-title">âŒ Rejets</h5>
                    <p class="display-6">{{ rejetees }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-secondary">
                <div class="card-body">
                    <h5 class="card-title">ğŸ•“ DurÃ©e moyenne</h5>
                    <p class="display-6">
                        {% if delais_par_niveau|length > 0 %}
                            {{ delais_par_niveau.0.moyenne|floatformat:1 }} j
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-dark">
                <div class="card-body">
                    <h5 class="card-title">ğŸ’° Recettes</h5>
                    
                    <p class="display-6">{{ recettes|format_montant}} CFA</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h5 class="card-title">ğŸ“† Ce mois</h5>
                    <p class="display-6">{{ demandes_ce_mois }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ“Š RÃ©partition par catÃ©gorie -->
    <hr><h4>ğŸ“Š RÃ©partition par catÃ©gorie dâ€™acte</h4>
    <table class="table table-bordered">
        <thead><tr><th>CatÃ©gorie</th><th>Nombre</th></tr></thead>
        <tbody>
            {% for cat in repartition_categories %}
                <tr><td>{{ cat.categorie_nom }}</td><td>{{ cat.total }}</td></tr>
            {% empty %}
                <tr><td colspan="2">Aucune donnÃ©e</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ğŸ“‰ Ã‰volution mensuelle -->
    <hr><h4>ğŸ“‰ Ã‰volution mensuelle des demandes</h4>
    <table class="table table-striped">
        <thead><tr><th>Mois</th><th>Demandes</th></tr></thead>
        <tbody>
            {% for mois, total in evolution %}
                <tr><td>{{ mois }}</td><td>{{ total }}</td></tr>
            {% empty %}
                <tr><td colspan="2">Aucune donnÃ©e</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ğŸ“ˆ DÃ©lai moyen par niveau -->
    <hr><h4>ğŸ“ˆ DÃ©lai moyen par niveau</h4>
    <table class="table table-hover">
        <thead><tr><th>Niveau</th><th>DÃ©lai moyen (j)</th></tr></thead>
        <tbody>
            {% for niveau in delais_par_niveau %}
                <tr><td>{{ niveau.niveau }}</td><td>{{ niveau.moyenne|floatformat:1 }}</td></tr>
            {% empty %}
                <tr><td colspan="2">Aucune donnÃ©e</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ğŸ’¸ Recettes par type dâ€™acte -->
    <hr><h4>ğŸ’¸ Recettes par type dâ€™acte</h4>
    <table class="table table-bordered">
        <thead><tr><th>Type dâ€™acte</th><th>Montant (CFA)</th></tr></thead>
        <tbody>
            {% for r in recettes_par_type %}
                <tr><td>{{ r.acte_nom }}</td><td>{{ r.montant|format_montant }} </td></tr>
            {% empty %}
                <tr><td colspan="2">Aucune recette enregistrÃ©e</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ğŸ” Suivis en attente -->
    <hr><h4>ğŸ” Suivis en attente (depuis +3 jours)</h4>
    <table class="table table-sm table-striped">
        <thead><tr><th>Demandeur</th><th>Niveau</th><th>Depuis (j)</th><th>Action</th></tr></thead>
        <tbody>
            {% for suivi in en_attente %}
                <tr>
                    <td>{{ suivi.demande.nom }} {{ suivi.demande.prenom }}</td>
                    <td>{{ suivi.niveau|title }}</td>
                    <td>{{ suivi.date_action|timesince }}</td>
                    <td><a href="{% url 'suivi_et_traitement_demande' suivi.demande.id %}" class="btn btn-warning btn-sm">ğŸ” Traiter</a></td>
                </tr>
            {% empty %}
                <tr><td colspan="4">Aucun suivi en attente</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ğŸ“Œ Top Agents -->
    <hr><h4>ğŸ“Œ Top 5 Agents actifs</h4>
    <table class="table table-striped">
        <thead><tr><th>Agent</th><th>Demandes traitÃ©es</th></tr></thead>
        <tbody>
            {% for agent in top_agents %}
                <tr><td>{{ agent.nom }} {{ agent.prenom }}</td><td>{{ agent.nb }}</td></tr>
            {% empty %}
                <tr><td colspan="2">Aucun agent actif</td></tr>
            {% endfor %}
        </tbody>
    </table>

</div>
{% endblock %}
