{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-5">
    
    {% if confirmation %}
      <div class="text-success fs-5 mb-4 text-center">
        ‚úÖ {{ confirmation }}
      </div>
    {% endif %}
    {% if erreur %}
      <div class="text-danger fs-5 mb-4 text-center">
        ‚ùå {{ erreur }}
      </div>
    {% endif %}

    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white text-center py-3">
            <h3 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Soumettre une demande d'acte administratif</h3>
        </div>
        <div class="card-body p-4">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Bloc Identit√© -->
                <h5 class="text-primary border-bottom pb-1 mb-3"><i class="bi bi-person-circle me-1"></i> Identit√© du demandeur</h5>
                <div class="row">
                    <div class="col-md-6">{{ form.nom|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.prenom|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.grade|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.nationalite|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.contact|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.email|as_crispy_field }}</div>
                </div>

                <!-- Bloc Localisation -->
                <h5 class="text-primary border-bottom pb-1 mt-4 mb-3"><i class="bi bi-geo-alt-fill me-1"></i> Localisation</h5>
                <div class="row">
                    <div class="col-md-4">{{ form.region|as_crispy_field }}</div>
                    <div class="col-md-4">{{  form.departement|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.commune|as_crispy_field }}</div>
                </div>

                <!-- Bloc Acte -->
                <h5 class="text-primary border-bottom pb-1 mt-4 mb-3"><i class="bi bi-journal-text me-1"></i> D√©tails de l'acte</h5>
                <div class="row">
                    <div class="col-md-6">{{ form.categorie|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.acte|as_crispy_field }}</div>
                </div>

                <!-- Champs conditionnels -->
                <div class="row mt-3">
                    <div class="col-md-6 d-none" id="champ_nom_etablissement">
                        {{ form.nom_etablissement|as_crispy_field }}
                        <small class="form-text text-muted">üìå Remplir si vous d√©clarez un √©tablissement v√©t√©rinaire.</small>
                    </div>
                    <div class="col-md-6 d-none" id="champ_type_import">
                        {{ form.nom_produit_importe_ou_exporte|as_crispy_field }}
                        <small class="form-text text-muted">üìå Remplir pour les autorisations d'import/export.</small>
                    </div>
                    <div class="col-md-6 d-none" id="champ_type_transformation">
                        {{ form.nom_unit√©_transformation|as_crispy_field }}
                        <small class="form-text text-muted">üìå Remplir pour les unit√©s de transformation.</small>
                    </div>
                </div>

                <!-- Pi√®ces justificatives -->
                <h5 class="text-primary border-bottom pb-1 mt-4 mb-3"><i class="bi bi-paperclip me-1"></i> Pi√®ces justificatives</h5>
                <div class="form-group">
                    <input type="file" name="justificatifs" id="id_justificatifs" multiple class="form-control">
                    <small class="form-text text-muted">
                        üìå Veuillez scanner et regrouper tous les documents en un <strong>seul fichier PDF</strong>.
                    </small>
                </div>

                <!-- Bouton -->
                <div class="mt-4 text-center">
                    <button type="submit" name="valider" value="soumettre" class="btn btn-success btn-lg px-5">
                        üì§ Soumettre la demande
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const regionSelect = document.querySelector('select[name="region"]');
        const departementSelect = document.querySelector('select[name="departement"]');
        const communeSelect = document.querySelector('select[name="commune"]');
        const categorieSelect = document.querySelector('select[name="categorie"]');
        const acteSelect = document.querySelector('select[name="acte"]');
    
        const blocEtablissement = document.getElementById("champ_nom_etablissement");
        const blocImport = document.getElementById("champ_type_import");
        const blocTransformation = document.getElementById("champ_type_transformation");
    
        // Affichage dynamique des champs selon la cat√©gorie
        function toggleChampsSpecifiques() {
            const selectedOption = categorieSelect.options[categorieSelect.selectedIndex]?.text?.toLowerCase() || '';
    
            blocEtablissement.classList.add("d-none");
            blocImport.classList.add("d-none");
            blocTransformation.classList.add("d-none");
    
            if (selectedOption.includes("√©tablissement")) {
                blocEtablissement.classList.remove("d-none");
            }
            if (selectedOption.includes("import")) {
                blocImport.classList.remove("d-none");
            }
            if (selectedOption.includes("transformation")) {
                blocTransformation.classList.remove("d-none");
            }
        }
    
        // Mise √† jour des d√©partements selon la r√©gion
        function updateDepartements() {
            const regionId = regionSelect.value;
            if (regionId) {
                fetch(`/api/departements/?region_id=${regionId}`)
                    .then(response => response.json())
                    .then(data => {
                        departementSelect.innerHTML = '<option value="">S√©lectionner un d√©partement</option>';
                        data.forEach(dept => {
                            departementSelect.innerHTML += `<option value="${dept.id}">${dept.Nom}</option>`;
                        });
                        communeSelect.innerHTML = '<option value="">S√©lectionner une commune</option>';
                    });
            } else {
                departementSelect.innerHTML = '<option value="">S√©lectionner un d√©partement</option>';
                communeSelect.innerHTML = '<option value="">S√©lectionner une commune</option>';
            }
        }
    
        // Mise √† jour des communes selon le d√©partement
        function updateCommunes() {
            const departementId = departementSelect.value;
            if (departementId) {
                fetch(`/api/communes/?departement_id=${departementId}`)
                    .then(response => response.json())
                    .then(data => {
                        communeSelect.innerHTML = '<option value="">S√©lectionner une commune</option>';
                        data.forEach(com => {
                            communeSelect.innerHTML += `<option value="${com.id}">${com.Nom}</option>`;
                        });
                    });
            } else {
                communeSelect.innerHTML = '<option value="">S√©lectionner une commune</option>';
            }
        }
    
        // Mise √† jour des types d‚Äôactes selon la cat√©gorie
        function updateActes() {
            const categorieId = categorieSelect.value;
            if (categorieId) {
                fetch(`/ajax/load-actes/?categorie=${categorieId}`)
                    .then(response => response.json())
                    .then(data => {
                        acteSelect.innerHTML = '<option value="">S√©lectionner un acte</option>';
                        data.forEach(acte => {
                            acteSelect.innerHTML += `<option value="${acte.id}">${acte.nom}</option>`;
                        });
                    });
            } else {
                acteSelect.innerHTML = '<option value="">S√©lectionner un acte</option>';
            }
        }
    
        // √âv√©nements listeners
        if (regionSelect) regionSelect.addEventListener("change", updateDepartements);
        if (departementSelect) departementSelect.addEventListener("change", updateCommunes);
        if (categorieSelect) {
            categorieSelect.addEventListener("change", updateActes);
            categorieSelect.addEventListener("change", toggleChampsSpecifiques);
        }
    
        // Initialisation si les valeurs sont pr√©remplies
        if (regionSelect?.value) updateDepartements();
        if (departementSelect?.value) updateCommunes();
        if (categorieSelect?.value) {
            updateActes();
            toggleChampsSpecifiques();
        }
    });
    </script>
    
{% endblock %}
