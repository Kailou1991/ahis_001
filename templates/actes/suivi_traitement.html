{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container mt-4" style="margin-left: 17%;">
    <h2 class="text-center">Traitement de la demande</h2>

    <!-- Message flash -->
    {% if messages %}
        <div class="mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Fermer">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Demande de {{ demande.nom }} {{ demande.prenom }}</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Grade :</strong> {{ demande.grade }}</p>
                    <p><strong>Nationalit√© :</strong> {{ demande.nationalite }}</p>
                    <p><strong>Contact :</strong> {{ demande.contact }}</p>
                    <p><strong>Email :</strong> {{ demande.email }}</p>
                    <p><strong>R√©gion :</strong> {{ demande.region }}</p>
                    <p><strong>D√©partement :</strong> {{ demande.departement }}</p>
                    <p><strong>Commune :</strong> {{ demande.commune }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Cat√©gorie :</strong> {{ demande.categorie }}</p>
                    <p><strong>Acte :</strong> {{ demande.acte }}</p>
                    {% if demande.nom_etablissement %}<p><strong>√âtablissement :</strong> {{ demande.nom_etablissement }}</p>{% endif %}
                    {% if demande.nom_produit_importe_ou_exporte %}<p><strong>Produit :</strong> {{ demande.nom_produit_importe_ou_exporte }}</p>{% endif %}
                    {% if demande.nom_unit√©_transformation %}<p><strong>Unit√© de transformation :</strong> {{ demande.nom_unit√©_transformation }}</p>{% endif %}
                    <p><strong>Statut :</strong> 
                        <span class="badge 
                            {% if demande.statut == 'en_cours' %}badge-warning
                            {% elif demande.statut == 'valide' %}badge-success
                            {% elif demande.statut == 'rejete' %}badge-danger
                            {% elif demande.statut == 'delivre' %}badge-info
                            {% endif %}">
                            {{ demande.get_statut_display }}
                        </span>
                    </p>
                    <p><strong>Niveau de traitement actuel :</strong> {{ suivi_actuel.niveau|title }}</p>
                </div>
            </div>
            <hr>
            <h5>Dossiers :</h5>
            <ul>
                {% for doc in demande.justificatifs.all %}
                    <li><a href="{{ doc.fichier.url }}" target="_blank">üìé {{ doc.nom }}</a></li>
                {% empty %}
                    <li>Aucun dossier joint.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="row mt-4 justify-content-center text-center">
        <div class="col-md-6">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% if suivi_actuel.niveau == 'central' and user.groups.all.0.name == 'Agent de suivi de demande' %}
                    <div class="mb-2 text-start">
                        <label><strong>Document sign√© (PDF) :</strong></label>
                        <input type="file" name="document_final" accept="application/pdf" class="form-control mb-2" required>
                    </div>
                    <input type="submit" name="traitement" value="valider_et_delivrer" class="btn btn-success w-100" />
                {% else %}
                    <input type="submit" name="traitement" value="valider" class="btn btn-success w-100" />
                {% endif %}
            </form>
        </div>

        <div class="col-md-3">
            <button type="button" class="btn btn-danger w-100"
                onclick="document.getElementById('form-rejet').style.display = 'block'; this.style.display='none';">
                ‚ùå Rejeter
            </button>
        </div>
    </div>

    <div id="form-rejet" class="mt-3" style="display: none;">
        <form method="post">
            {% csrf_token %}
            <div class="card">
                <div class="card-body">
                    <label><strong>Motif du rejet :</strong></label>
                    <textarea name="motif_rejet" class="form-control mb-2" rows="3" required></textarea>
                    <input type="submit" name="traitement" value="rejeter" class="btn btn-danger w-100" />
                </div>
            </div>
        </form>
    </div>

    <!-- Historique -->
    <div class="mt-5">
        <h5>Historique du suivi</h5>
        <ul class="list-group">
            {% for suivi in suivis %}
                <li class="list-group-item">
                    <strong>{{ suivi.niveau|title }}</strong> | {{ suivi.get_statut_display }} ‚Äî
                    <em>{{ suivi.date_action|date:"d/m/Y H:i" }}</em>
                    {% if suivi.motif_rejet %}
                        <br><span class="text-danger">Motif du rejet : {{ suivi.motif_rejet }}</span>
                    {% endif %}
                </li>
            {% empty %}
                <li class="list-group-item">Aucun suivi enregistr√©.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="mt-4 text-center">
        <a href="{% url 'liste_demandes' %}" class="btn btn-secondary">‚¨Ö Retour √† la liste</a>
    </div>
</div>
{% endblock %}
