{% extends 'base.html' %}

{% block content %}
<div class="container mt-4" style="width: 60%; margin-left: 20%;">
    <h2>{% if form.instance.pk %}Modification d'un produit{% else %}Créer un nouveau produit{% endif %}</h2>
    {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">
          {{ message }}
      </div>
    {% endfor %}
  {% endif %}
  
    <form id="addProduitForm" method="post" novalidate >
        {% csrf_token %}

        <!-- Affichage des erreurs globales -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        {% for field in form %}
            <div class="form-group" id="{{ field.name }}-field">
                <label>{{ field.label }}</label>
                {{ field }}
                <div class="text-danger">{{ field.errors }}</div>
            </div>
        {% endfor %}

        <button type="submit" class="btn btn-success mt-3">Enregistrer</button>

    </form>
</div>

<!-- Script JS -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const typeProduitField = document.querySelector('[name="type_produit"]');
    const classeTherapeutiqueField = document.querySelector('[name="classe_therapeutique"]');

    function updateFieldVisibility() {
        const selectedType = typeProduitField.value;
        const selectedClasse = classeTherapeutiqueField ? classeTherapeutiqueField.value : null;

        const alwaysShow = [
            'nom_du_produit-field',
            'type_produit-field'
            
        ];
        const antibiotiqueFieldId = 'familles_antibiotiques-field';

        if (selectedType !== 'MEDICAMENT') {
            document.querySelectorAll('.form-group').forEach(group => {
                const fieldId = group.id;
                group.style.display = alwaysShow.includes(fieldId) ? 'block' : 'none';
            });
            return;
        }

        // Si médicament : tout afficher
        document.querySelectorAll('.form-group').forEach(group => {
            group.style.display = 'block';
        });

        // Masquer familles_antibiotiques si classe ≠ ANTIMICROBIEN
        const antibiotiqueDiv = document.getElementById(antibiotiqueFieldId);
        if (selectedClasse !== 'ANTIMICROBIEN' && antibiotiqueDiv) {
            antibiotiqueDiv.style.display = 'none';
        }
    }

    if (typeProduitField) {
        updateFieldVisibility();
        typeProduitField.addEventListener('change', updateFieldVisibility);
    }
    if (classeTherapeutiqueField) {
        classeTherapeutiqueField.addEventListener('change', updateFieldVisibility);
    }
});
</script>
{% endblock %}
